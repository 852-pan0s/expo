{"version":3,"file":"ExpoRequestor.js","sourceRoot":"","sources":["../src/ExpoRequestor.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,YAAY,EAAE,SAAS,EAAE,MAAM,iBAAiB,CAAC;AAE1D,OAAO,EAAE,GAAG,EAAE,eAAe,EAAE,MAAM,OAAO,CAAC;AAE7C;;GAEG;AACH,MAAM,OAAO,aAAc,SAAQ,SAAS;IAC1C,8CAA8C;IAC9C,+GAA+G;IAC/G,cAAc;QACZ,qFAAqF;QACrF,+FAA+F;QAC/F,+CAA+C;QAC/C,OAAO,2CAA2C,CAAC;QACnD,2DAA2D;IAC7D,CAAC;IAED,aAAa,CACX,QAA4B;QAE5B,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAE;YACjB,MAAM,IAAI,YAAY,CAAC,yBAAyB,CAAC,CAAC;SACnD;QACD,MAAM,GAAG,GAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,GAAa,CAAC,CAAC;QACjD,MAAM,WAAW,GAAgB;YAC/B,MAAM,EAAE,QAAQ,CAAC,MAAM;YACvB,IAAI,EAAE,MAAM;SACb,CAAC;QAEF,IAAI,QAAQ,CAAC,IAAI,EAAE;YACjB,IAAI,QAAQ,CAAC,MAAM,EAAE,WAAW,EAAE,KAAK,MAAM,EAAE;gBAC7C,WAAW,CAAC,IAAI,GAAG,QAAQ,CAAC,IAAc,CAAC;aAC5C;iBAAM;gBACL,MAAM,YAAY,GAAG,IAAI,eAAe,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;gBACxD,YAAY,CAAC,OAAO,CAAC,CAAC,KAAK,EAAE,GAAG,EAAE,EAAE;oBAClC,GAAG,CAAC,YAAY,CAAC,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;gBACtC,CAAC,CAAC,CAAC;aACJ;SACF;QAED,0BAA0B;QAC1B,WAAW,CAAC,OAAO,GAAG,EAAE,CAAC;QACzB,IAAI,QAAQ,CAAC,OAAO,EAAE;YACpB,KAAK,MAAM,CAAC,IAAI,QAAQ,CAAC,OAAO,EAAE;gBAChC,IAAI,CAAC,IAAI,QAAQ,CAAC,OAAO,EAAE;oBACzB,WAAW,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAW,CAAC;iBACxD;aACF;SACF;QAED,MAAM,cAAc,GAAG,QAAQ,CAAC,QAAQ,EAAE,WAAW,EAAE,KAAK,MAAM,CAAC;QAEnE,IAAI,cAAc,IAAI,CAAC,CAAC,QAAQ,IAAI,WAAW,CAAC,OAAO,CAAC,EAAE;YACxD,WAAW,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC;SACvD;QACD,OAAO,EAAE,IAAI,EAAE,WAAW,EAAE,cAAc,EAAE,GAAG,EAAE,CAAC;IACpD,CAAC;IAED,KAAK,CAAC,GAAG,CAAI,QAA4B;QACvC,MAAM,EAAE,IAAI,EAAE,cAAc,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;QACnE,MAAM,QAAQ,GAAG,MAAM,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,EAAE,IAAI,CAAC,CAAC;QAEnD,MAAM,WAAW,GAAG,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;QACzD,IAAI,cAAc,IAAI,WAAW,EAAE,QAAQ,CAAC,kBAAkB,CAAC,EAAE;YAC/D,OAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;SACxB;QACD,2DAA2D;QAC3D,OAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;IACzB,CAAC;CACF","sourcesContent":["import { AppAuthError, Requestor } from '@openid/appauth';\n\nimport { URL, URLSearchParams } from './URL';\n\n/**\n * Extends Requester\n */\nexport class ExpoRequestor extends Requestor {\n  // Set 'Accept' header value for json requests\n  // (Taken from https://github.com/jquery/jquery/blob/e0d941156900a6bff7c098c8ea7290528e468cf8/src/ajax.js#L644)\n  getJsonHeaders(): string {\n    // WARNING: Github authentication will return XML if this includes the standard `*/*`\n    // we'll remove the */* property for now. Override this class in the future if it has problems.\n    // https://github.com/expo/expo/pull/3828/files\n    return 'application/json, text/javascript; q=0.01';\n    // return 'application/json, text/javascript, */*; q=0.01';\n  }\n\n  createRequest(\n    settings: JQueryAjaxSettings\n  ): { init: RequestInit; url: URL; isJsonDataType: boolean } {\n    if (!settings.url) {\n      throw new AppAuthError('A URL must be provided.');\n    }\n    const url: URL = new URL(settings.url as string);\n    const requestInit: RequestInit = {\n      method: settings.method,\n      mode: 'cors',\n    };\n\n    if (settings.data) {\n      if (settings.method?.toUpperCase() === 'POST') {\n        requestInit.body = settings.data as string;\n      } else {\n        const searchParams = new URLSearchParams(settings.data);\n        searchParams.forEach((value, key) => {\n          url.searchParams.append(key, value);\n        });\n      }\n    }\n\n    // Set the request headers\n    requestInit.headers = {};\n    if (settings.headers) {\n      for (const i in settings.headers) {\n        if (i in settings.headers) {\n          requestInit.headers[i] = settings.headers[i] as string;\n        }\n      }\n    }\n\n    const isJsonDataType = settings.dataType?.toLowerCase() === 'json';\n\n    if (isJsonDataType && !('Accept' in requestInit.headers)) {\n      requestInit.headers['Accept'] = this.getJsonHeaders();\n    }\n    return { init: requestInit, isJsonDataType, url };\n  }\n\n  async xhr<T>(settings: JQueryAjaxSettings): Promise<T> {\n    const { init, isJsonDataType, url } = this.createRequest(settings);\n    const response = await fetch(url.toString(), init);\n\n    const contentType = response.headers.get('content-type');\n    if (isJsonDataType || contentType?.includes('application/json')) {\n      return response.json();\n    }\n    // @ts-ignore: Type 'string' is not assignable to type 'T'.\n    return response.text();\n  }\n}\n"]}